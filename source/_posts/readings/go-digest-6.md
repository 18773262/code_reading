---
title: 技术阅读摘要 - 6.从云原生五个技术特征谈Go语言框架
date: 2022-08-29 12:00:00
categories: 
- 成长分享
tags:
- Digest
---

## 概览

云原生如今作为最具代表性的技术趋势之一，在全球范围内如火如荼地推进。云原生有五个最具代表性的技术特征：容器、服务网格、微服务、不可变基础结构和声明式API。

而作为云原生环境下的Go语言开发者，我们经常会疑惑：什么样的Go语言框架才是适配云原生的呢？今天，我将通过对这五个技术特征的分析，来聊聊自己的理解。

> 下文讨论的，主要针对的是web类服务的Go语言框架，也包含编程时的一些思想和理念。

<!-- more -->

## 容器 Container

容器本身与语言无关，但它非常强调一个特性：程序的无状态化。

如何进行无状态化地编程，话题涉及很多方面。Go语言框架能做的比较有限，最具代表性的，是能够实现 **server的优雅停止** ，也就是让服务先停止接收新请求，处理完当前请求后，再停止进程。

无状态化，更多地是要我们在编写业务代码时充分思考，例如：

1. buffered channel 的大小要么为0，要么为1
2. 避免野生的goroutine
3. 避免耗时长的处理逻辑
4. 有重试时，保证逻辑的幂等性

## 服务网格 Service Mesh

由于服务网格的落地时间比绝大部分的编程语言框架要晚得多，所以两者有大量的重合点：最经典的就是RPC调用的超时与重试，大部分的Go框架都能实现了这个功能，但更符合云原生的方式则是应该放在Service Mesh里。

那么，如果有个新框架，在设计之初就将Mesh和编程语言划分清楚，就能避免这个问题了吗？我个人不太乐观：Service Mesh还未完全成熟，有许多仍在探索的最佳实践，很难一步到位。

而Mesh和语言框架无法直接解决的问题，那就增加一层：我们完全可以借助跨语言RPC方案种的IDL的定义，进行一定的延伸：
- 当某功能不成熟时，用编程语言的框架快速实现
- 当某功能成熟后，将能力注入到Mesh的控制层

所以，我非常推荐IDL这种技术方案，它在跨语言和技术升级过程中，更具平滑性。

## 微服务 Microservice

微服务对框架的最大考验是RPC上的解决方案，这部分的最佳实践往往就是IDL方案，不仅支持跨语言，也具备高性能。

但是，微服务除了强调 **微** ，它的本质上还是一个 **服务** ，我们必须考虑代码的可维护性。对于这块，业界已经基本达成一致，主要有如下三点考量：
1. 代码的合理分层
2. 以 **DI/IoC** 为代表的面向对象的设计思路
3. 一定代码生成能力，减少重复性的编程

## 不可变基础结构 Immutable Infrastructure

不可变基础结构的很多细节与容器有交集，往往可以结合到一起来看。

在云原生下，不可变基础结构主要通过2个方向保障：
1. 用完善的CICD流水线，保证整个流程自动化，无法被人工修改
2. 用完善的各种组件库，将 **变化项** 转移到合理的云上平台

其中，第二点是Go语言框架要重点建设的。比如文件读写这个功能，如果用传统的磁盘读写，那就会修改容器状态，是*可变*的，应该调整为用一套SDK对接云上的OSS。

## 声明式API Declarative API

声明式API，简而言之，就是客户端用接口表达 **预期状态** ，由服务端保证将对象从 **当前状态** 迁移至对应的预期。

对调用方来说，整个操作会非常简单，操作两个接口即可：
1. 查询当前状态
2. 声明所需的预期状态

而服务提供方，核心提供的能力类似于 **Kubernetes的kube-controller-manager**，分析预期状态和当前状态的差异，再执行对应的增删改操作。从这个角度来看，传统CRUD的操作依然存在，可以体现在命令式API接口上。

声明式和命令式API在相当一段时间内会共存，我们完全可以在命令式API接口上封装出一层声明式API的能力，慢慢地进行平滑迁移。而在微服务框架中，一方面要提供便捷的接口开发能力，另一方面也可以尝试提供出类似于 **声明式 -> 命令式** 功能迁移的能力。

## 小结

本文从云原生的五个技术特征角度，分析了对Go语言框架的影响，也同样适用于其它语言框架。

如果要选出最为核心的一个技术点，我认为是以IDL为核心的跨语言RPC方案，它的优点可以从两个角度来看：
- 对于Client，可以屏蔽Service Mesh等复杂技术细节，自动生成SDK
- 对于Server，可以生成RPC方法的框架、让开发者填充式地实现

> Github: https://github.com/Junedayday/code_reading
>
> Blog: http://junes.tech/
>
> Bilibili: https://space.bilibili.com/293775192
>
> 公众号: golangcoding
>
>  ![二维码](https://i.loli.net/2021/02/28/RPzy7Hjc9GZ8I3e.jpg)

