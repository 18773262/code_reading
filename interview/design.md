## 基本理论

### 软件设计文档

- 需求分析
- 概要设计
- 详细设计

### 高可用武器

- 解耦
- 隔离
- 异步
- 备份
- 重试
- 熔断
- 补偿
- 限流
- 降级
- 多活

## 短 URL 生成器设计

### 需求分析

- 功能需求
  - 生成唯一的短 URL
  - 将请求重定向到原始长 URL
  - 后台检索，可管理
  - 有效期2年，自动清理
- 性能指标估算
  - 存储空间
  - 吞吐量，高峰期*2
  - 网络带宽
    - 单位为Mb，注意要*8bit
- 其余需求
  - 高可用
  - 高性能
  - URL不可猜测

### 概要设计

- 算法
  - 单项散列函数生成短 URL
    - 冲突后再散列计算
  - 自增长短 UR
    - 可猜测
  - 预生成短 URL
- 整体部署
  - 访问集群
    - 缓存Redis
    - 映射Hbase
  - 预加载集群
  - 预生成集群
  - 清理集群

### 详细设计

- 重定向响应码
  - 301 永久重定向
  - 302 临时重定向
- 短 URL 预生成文件及预加载
- URL Base64 编码
  - URL 保留字符编码表



## 网页爬虫设计

### 需求分析

- 功能需求
- 非功能需求
  - 伸缩性
  - 健壮性
  - 去重：URL、内容
  - 扩展性：文字、图片、视频
  - 爬虫协议

### 概要设计

- URL 调度器服务器
  - 种子URL - 起点
- URL 下载处理服务器集群
- HDFS

### 详细设计

- URL 调度器算法
  - BFS
  - 根据网页质量进行优先级分类，不同队列
- 去重算法
  - URL去重 - 布隆过滤器
  - 内容去重 - 提取HTML中有效内容，再计算md5、布隆过滤
- 高可用设计
  - 机器重启：Redis记录运行数据
  - 下载超时或内容解析错误：多线程+异常处理机制

## 网盘系统设计

### 需求分析

- 功能需求 -存储与网络密集
  - 硬盘资源
  - 流速控制
  - QPS - 1w
  - 带宽 - 80Gb/s
- 非功能需求
  - 高可靠存储
  - 高可用服务
  - 数据安全性
  - 不重复上传

### 概要设计

关键 - 元数据与文件内容的分离存储与管理

- 文件存储方案 - 对象存储Ceph
  - 切分
  - 以 Block 为单位进行上传和下载，提高文件传输速度
  - 断点续传
- API服务器+数据库
- Block服务器+Ceph

### 详细设计

- 元数据库管理
  - User表 - user_id分片
  - File表 - user_id分片
  - Block表 - file_id分片
- 上传下载限速
  - Block 服务器限速
- 秒传的设计实现
  - 文件相同的三个条件
    - 文件长度
    - 文件开头 256KB 的 MD5 值
    - 文件的 MD5 值
  - file表抽象出logic_file

## 短视频系统设计

### 需求分析

- 功能需求
  - 用户上传视频
  - 搜索视频
  - 观看视频
- 非功能需求

### 概要设计

- 负载均衡服务器
- 网关服务器
- 视频文件
  - 暂存服务器
  - 处理服务
    - 内容合规性审查
    - 内容重复性及质量审查
    - 内容标签生成
    - 视频缩略图生成
    - 统一视频转码处理
  - 存储服务器
- 上传服务
  - MySQL
- 搜索服务
  - 倒排索引
- 播放服务
  - CDN

### 详细设计

- 视频存储系统设计
  - HDFS适合存储大文件
  - 信息记录到 HBase
- 性能优化与 CDN 设计
  - 大粉丝：主动推送 CDN 的方法，以提高 CDN 的命中率
    - 活跃粉丝数
    - 粉丝分布区域
  - 完播率通常不足 30%，不需要缓存全部
- 缩略图生成与推荐设计
  - 大数据平台的机器学习引擎：实时在线和离线机器学习循环迭代



## 秒杀系统设计

### 需求分析

- 独立开发部署系统，避免影响现有系统和业务
- 防止跳过秒杀页面直接下单

### 概要设计

- 独立秒杀系统页面设计
  - 购买和下单两个页面
- 秒杀系统的流量控制
  - 缓存：浏览器、CDN
  - 计数器
- 购买按钮点亮方案设计与下单 URL 下发
  - 一个特殊的 JavaScript 文件
    - 不被任何地方缓存
    - 未开始时为空
    - 开始后，定时任务推送到Js服务器
- 秒杀系统部署模型
  - 检查请求中的随机数



## 交友系统设计

### 需求分析

- 用户规模：10亿
- 推荐邻近用户

### 概要设计

- 网关服务器
  - 限流、防攻击、用户身份识别及权限验证、微服务调用及数据聚合封装
- 微服务
  - 用户
  - 图片
  - 配对
  - 聊天
  - 推荐

### 详细设计

临近算法

- SQL 邻近算法
  - select * from users where latitude between X-D and X+D and longtitude between Y-D and Y+D;
- 地理网格邻近算法
  - 如何恰当地选择网格的大小
- 动态网格算法 - 4 叉树网格
  - 当用户增加，超过阈值（500 个用户）的时候，就分裂出 4 个子树
  - 找到叶子节点
  - 所有叶子节点组成双向链表，前驱和后驱节点就是相邻节点
- GeoHash 算法
  - 二进制编码
  - 跳表存储
  - 先计算用户当前网格，不足数量再取周围网格

## 搜索引擎设计

### 需求分析

- 高效地进行数据管理
- 快速查找包含搜索词的网页内容
- 对搜索结果的网页内容进行排序

### 概要设计

- 系统架构
  - 分布式爬虫
  - 存储服务器
    - HDFS - docID
  - 索引构造器
    - URL提取器
    - 链接关系器
    - 索引桶 - 根据 docID 取模
  - PageRank
    - 排序器
  - 搜索器

### 详细设计

- 索引
  - 倒排索引
- 两个索引求交集 - 有序链表
  - 数据分片
  - 有序链表转成跳表
- PageRank
  - 随机跳转的概率0.85

## 微博系统设计

### 需求分析

- 3个功能
  - 发微博
  - 关注好友
  - 刷微博
- 性能
  - 2亿DAU
  - 一条微博：140字 * 3Byte=420B+其余数据，约500B
  - 多媒体，图片500K，视频2M
  - QPS约5w，高峰期10w
  - 网络4.8Tb/s

### 概要设计

- 读请求
  - 90% 可以通过 CDN
- 写请求
  - 图片或视频 - 分布式文件系统
  - 文字
    - 写缓存
    - 消息队列到分布式MySQL

### 详细设计

- 微博的发表 / 订阅问题
  - 推模式：用户在线
  - 拉模式：用户不在线
  - 推拉结合
- 缓存使用策略
  - LRU不适用，而是按时间（如7天）缓存
  - 热点key：本地缓存模式，百万大V的48小时微博
- 数据库分片策略
  - 用户 ID 分片 - 限制发送数量、缓存热点数据

## 百科应用系统设计

### 概要设计

- 多数据中心架构
  - 数据一致性 - 一主多从
  - Nginx判断，写请求直接到主节点

### 详细设计

- 前端性能优化
  - CDN 服务
  - Nginx 集群
- 服务端性能优化
- 存储端性能优化
  - RAID5磁盘阵列